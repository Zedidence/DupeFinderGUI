<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duplicate Image Finder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 30px;
        }
        
        header h1 {
            font-size: 2.5rem;
            color: #fff;
            margin-bottom: 10px;
        }
        
        header p {
            color: #888;
            font-size: 1.1rem;
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connection-status.connected {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
        }
        
        .connection-status.disconnected {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .connection-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        /* Session Recovery Banner */
        .recovery-banner {
            background: linear-gradient(135deg, #2d3436, #1a1a2e);
            border: 1px solid #4a9eff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .recovery-banner.active {
            display: block;
        }
        
        .recovery-banner h3 {
            color: #4a9eff;
            margin-bottom: 10px;
        }
        
        .recovery-banner p {
            color: #888;
            margin-bottom: 15px;
        }
        
        .recovery-banner .btn-group {
            display: flex;
            gap: 10px;
        }
        
        /* Warning Banner */
        .warning-banner {
            background: linear-gradient(135deg, #2d3436, #1a1a2e);
            border: 1px solid #f39c12;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .warning-banner.active {
            display: block;
        }
        
        .warning-banner h3 {
            color: #f39c12;
            margin-bottom: 10px;
        }
        
        .warning-banner p {
            color: #888;
            margin-bottom: 10px;
        }
        
        .warning-banner code {
            background: #0f0f23;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: #4a9eff;
        }
        
        /* Cache Info Banner */
        .cache-banner {
            background: linear-gradient(135deg, #1a3a1a, #1a1a2e);
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            font-size: 0.9rem;
            color: #27ae60;
        }
        
        .cache-banner.active {
            display: flex;
        }
        
        /* Setup Panel */
        .setup-panel {
            background: #16213e;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #ccc;
        }
        
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #0f0f23;
            color: #fff;
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4a9eff;
        }
        
        .form-group small {
            color: #666;
            margin-top: 4px;
            display: block;
        }
        
        /* Directory Autocomplete */
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #0f0f23;
            border: 2px solid #333;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        
        .autocomplete-list.active {
            display: block;
        }
        
        .autocomplete-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #333;
        }
        
        .autocomplete-item:hover {
            background: #1a1a3e;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .checkbox-group {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Advanced Options */
        .advanced-options {
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 20px;
        }
        
        .advanced-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #888;
            cursor: pointer;
            font-size: 0.95rem;
            margin-bottom: 15px;
            user-select: none;
        }
        
        .advanced-toggle:hover {
            color: #4a9eff;
        }
        
        .advanced-toggle .arrow {
            transition: transform 0.3s;
        }
        
        .advanced-toggle.expanded .arrow {
            transform: rotate(90deg);
        }
        
        .advanced-content {
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .advanced-content.active {
            display: block;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4a9eff, #6c5ce7);
            color: #fff;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 158, 255, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: #fff;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
            color: #fff;
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
        
        .btn-success {
            background: #27ae60;
            color: #fff;
        }
        
        .btn-secondary {
            background: #333;
            color: #fff;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Progress Section */
        .progress-section {
            margin-top: 30px;
            display: none;
        }
        
        .progress-section.active {
            display: block;
        }
        
        /* Stage Indicators */
        .stage-indicators {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
        }
        
        .stage-indicators::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 3px;
            background: #333;
            z-index: 0;
        }
        
        .stage-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            flex: 1;
        }
        
        .stage-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        
        .stage-indicator.active .stage-dot {
            background: #4a9eff;
            box-shadow: 0 0 20px rgba(74, 158, 255, 0.5);
        }
        
        .stage-indicator.completed .stage-dot {
            background: #27ae60;
        }
        
        .stage-indicator.error .stage-dot {
            background: #e74c3c;
        }
        
        .stage-label {
            font-size: 0.85rem;
            color: #666;
            text-align: center;
        }
        
        .stage-indicator.active .stage-label,
        .stage-indicator.completed .stage-label {
            color: #fff;
        }
        
        /* Progress Bar */
        .progress-container {
            margin-bottom: 20px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .progress-title {
            font-weight: 600;
        }
        
        .progress-percentage {
            color: #4a9eff;
            font-weight: 600;
        }
        
        .progress-bar {
            height: 12px;
            background: #333;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a9eff, #6c5ce7);
            width: 0%;
            transition: width 0.3s;
            position: relative;
        }
        
        .progress-fill.animated {
            background-image: linear-gradient(
                -45deg,
                rgba(255,255,255,0.15) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255,255,255,0.15) 50%,
                rgba(255,255,255,0.15) 75%,
                transparent 75%,
                transparent
            );
            background-size: 40px 40px;
            animation: progressStripe 1s linear infinite;
        }
        
        @keyframes progressStripe {
            from { background-position: 0 0; }
            to { background-position: 40px 0; }
        }
        
        .progress-text {
            color: #888;
            font-size: 0.9rem;
            margin-top: 8px;
        }
        
        /* Live Stats */
        .live-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: #0f0f23;
            border-radius: 10px;
        }
        
        .live-stat {
            text-align: center;
        }
        
        .live-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4a9eff;
        }
        
        .live-stat-value.cache {
            color: #27ae60;
        }
        
        .live-stat-value.error {
            color: #e74c3c;
        }
        
        .live-stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
        }
        
        /* Scan Controls */
        .scan-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        /* Stats Bar */
        .stats-bar {
            display: none;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            padding: 20px;
            background: #16213e;
            border-radius: 12px;
        }
        
        .stats-bar.active {
            display: flex;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px 20px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4a9eff;
        }
        
        .stat-value.error {
            color: #e74c3c;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #888;
            margin-top: 4px;
        }
        
        /* Filter/Sort Bar */
        .filter-bar {
            display: none;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-bar.active {
            display: flex;
        }
        
        .filter-bar select {
            padding: 10px 15px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #0f0f23;
            color: #fff;
            font-size: 0.9rem;
        }
        
        .filter-bar input[type="text"] {
            padding: 10px 15px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #0f0f23;
            color: #fff;
            font-size: 0.9rem;
            width: 200px;
        }
        
        .pagination {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #0f0f23;
            color: #fff;
            cursor: pointer;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination span {
            color: #888;
        }
        
        /* Groups */
        .groups-container {
            display: none;
        }
        
        .groups-container.active {
            display: block;
        }
        
        .group-card {
            background: #16213e;
            border-radius: 12px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #1a1a3e;
            border-bottom: 1px solid #333;
        }
        
        .group-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .group-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .group-badge.exact {
            background: #e74c3c;
        }
        
        .group-badge.perceptual {
            background: #f39c12;
        }
        
        .group-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .image-card {
            background: #0f0f23;
            border-radius: 10px;
            overflow: hidden;
            border: 3px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .image-card:hover {
            border-color: #4a9eff;
        }
        
        .image-card.selected {
            border-color: #27ae60;
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.3);
        }
        
        .image-card.to-delete {
            border-color: #e74c3c;
            opacity: 0.7;
        }
        
        .image-preview {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: #000;
        }
        
        .image-info {
            padding: 15px;
        }
        
        .image-filename {
            font-weight: 600;
            margin-bottom: 8px;
            word-break: break-all;
            font-size: 0.95rem;
        }
        
        .image-path {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 10px;
            word-break: break-all;
        }
        
        .image-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85rem;
        }
        
        .meta-item {
            display: flex;
            justify-content: space-between;
        }
        
        .meta-label {
            color: #888;
        }
        
        .meta-value {
            color: #fff;
            font-weight: 500;
        }
        
        .quality-score {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #333;
        }
        
        .quality-bar {
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }
        
        .quality-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #27ae60);
            border-radius: 3px;
        }
        
        .image-wrapper {
            position: relative;
        }
        
        .keep-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #27ae60;
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .delete-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Error Section */
        .error-section {
            background: #16213e;
            border-radius: 12px;
            margin-bottom: 30px;
            overflow: hidden;
            display: none;
        }
        
        .error-section.active {
            display: block;
        }
        
        .error-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #2d1f1f;
            border-bottom: 1px solid #e74c3c;
            cursor: pointer;
        }
        
        .error-section-header:hover {
            background: #3d2a2a;
        }
        
        .error-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e74c3c;
        }
        
        .error-section-toggle {
            color: #e74c3c;
            font-size: 1.5rem;
            transition: transform 0.3s;
        }
        
        .error-section.expanded .error-section-toggle {
            transform: rotate(180deg);
        }
        
        .error-section-content {
            display: none;
            padding: 20px;
        }
        
        .error-section.expanded .error-section-content {
            display: block;
        }
        
        .error-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .error-image-item {
            background: #0f0f23;
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid #e74c3c;
        }
        
        .error-image-path {
            font-size: 0.85rem;
            color: #ccc;
            word-break: break-all;
            margin-bottom: 8px;
        }
        
        .error-image-error {
            font-size: 0.8rem;
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 8px;
            border-radius: 4px;
        }
        
        /* Action Bar */
        .action-bar {
            position: sticky;
            bottom: 0;
            background: #16213e;
            border-top: 1px solid #333;
            padding: 20px;
            display: none;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            z-index: 100;
        }
        
        .action-bar.active {
            display: flex;
        }
        
        .action-summary {
            font-size: 1rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Strategy Selector */
        .strategy-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .strategy-selector label {
            color: #888;
            font-size: 0.9rem;
        }
        
        .strategy-selector select {
            padding: 8px 12px;
            border: 2px solid #333;
            border-radius: 6px;
            background: #0f0f23;
            color: #fff;
            font-size: 0.85rem;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: #16213e;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal h2 {
            margin-bottom: 15px;
        }
        
        .modal p {
            color: #888;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* Lightbox */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        
        .lightbox.active {
            display: flex;
        }
        
        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            color: #fff;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3rem;
            color: #fff;
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            border: none;
            padding: 20px;
            border-radius: 8px;
        }
        
        .lightbox-nav.prev { left: 20px; }
        .lightbox-nav.next { right: 20px; }
        
        /* No Results */
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        
        .no-results h2 {
            color: #27ae60;
            margin-bottom: 10px;
        }
        
        /* Range Slider */
        .range-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .range-container input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 8px;
            background: #333;
            border-radius: 4px;
            outline: none;
        }
        
        .range-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4a9eff;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .range-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: #4a9eff;
        }
        
        /* Undo Toast */
        .undo-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 1001;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .undo-toast.active {
            display: flex;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .stats-bar {
                justify-content: center;
            }
            
            .action-bar {
                flex-direction: column;
                text-align: center;
            }
            
            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .pagination {
                margin-left: 0;
                justify-content: center;
            }
            
            .stage-indicators {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .stage-indicator {
                flex: 0 0 auto;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div class="connection-status connected" id="connectionStatus">
        <span class="dot"></span>
        <span id="connectionText">Connected</span>
    </div>
    
    <div class="container">
        <header>
            <h1>üîç Duplicate Image Finder</h1>
            <p>Find and manage duplicate images with ease</p>
        </header>
        
        <!-- Session Recovery Banner -->
        <div class="recovery-banner" id="recoveryBanner">
            <h3>üìÇ Previous Session Found</h3>
            <p id="recoveryInfo">You have results from a previous scan. Would you like to restore them?</p>
            <div class="btn-group">
                <button class="btn btn-primary btn-sm" onclick="restoreSession()">Restore Session</button>
                <button class="btn btn-secondary btn-sm" onclick="dismissRecovery()">Start Fresh</button>
            </div>
        </div>
        
        <!-- Warning Banner -->
        <div class="warning-banner" id="warningBanner">
            <h3>‚ö†Ô∏è Large Collection - Perceptual Matching Disabled</h3>
            <p id="warningInfo">This collection has over 50,000 images. Perceptual matching was automatically disabled.</p>
            <p>Enable LSH in Advanced Options to process large collections with perceptual matching.</p>
        </div>
        
        <!-- Setup Panel -->
        <div class="setup-panel" id="setupPanel">
            <div class="form-group">
                <label for="directory">üìÅ Directory to Scan</label>
                <input type="text" id="directory" placeholder="Enter full path (e.g., C:\Users\Photos or /home/user/photos)" 
                       autocomplete="off" onfocus="showHistory()" oninput="filterHistory()">
                <div class="autocomplete-list" id="historyList"></div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="threshold">üéØ Similarity Threshold</label>
                    <div class="range-container">
                        <input type="range" id="threshold" min="0" max="64" value="10" oninput="updateThresholdDisplay()">
                        <span class="range-value" id="thresholdValue">10</span>
                    </div>
                    <small>Lower = stricter matching (0-64). Recommended: 5-15</small>
                </div>
                
                <div class="form-group">
                    <label for="autoSelectStrategy">üéØ Auto-Select Strategy</label>
                    <select id="autoSelectStrategy">
                        <option value="quality">Keep Highest Quality</option>
                        <option value="largest">Keep Largest File</option>
                        <option value="smallest">Keep Smallest File</option>
                        <option value="newest">Keep Newest File</option>
                        <option value="oldest">Keep Oldest File</option>
                    </select>
                    <small>How to automatically select which image to keep</small>
                </div>
            </div>
            
            <div class="form-group">
                <label>Detection Mode</label>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="exactOnly" onchange="toggleDetectionMode('exact')">
                        Exact matches only
                    </label>
                    <label>
                        <input type="checkbox" id="perceptualOnly" onchange="toggleDetectionMode('perceptual')">
                        Perceptual matches only
                    </label>
                </div>
            </div>
            
            <!-- Advanced Options -->
            <div class="advanced-options">
                <div class="advanced-toggle" onclick="toggleAdvancedOptions()">
                    <span class="arrow">‚ñ∂</span>
                    <span>Advanced Options</span>
                </div>
                
                <div class="advanced-content" id="advancedContent">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="workers">‚ö° Worker Threads</label>
                            <div class="range-container">
                                <input type="range" id="workers" min="1" max="16" value="4" oninput="updateWorkersDisplay()">
                                <span class="range-value" id="workersValue">4</span>
                            </div>
                            <small>More workers = faster analysis, more CPU usage</small>
                        </div>
                        
                        <div class="form-group">
                            <label>üîß Performance Options</label>
                            <div class="checkbox-group" style="flex-direction: column; gap: 10px;">
                                <label>
                                    <input type="checkbox" id="useCache" checked>
                                    Use cache (faster re-scans)
                                </label>
                                <label>
                                    <input type="checkbox" id="recursive" checked>
                                    Scan subdirectories
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>üöÄ LSH Acceleration (Large Collections)</label>
                        <div class="checkbox-group">
                            <label>
                                <input type="radio" name="lshMode" value="auto" checked>
                                Auto (enable for 5,000+ images)
                            </label>
                            <label>
                                <input type="radio" name="lshMode" value="on">
                                Force On
                            </label>
                            <label>
                                <input type="radio" name="lshMode" value="off">
                                Force Off
                            </label>
                        </div>
                        <small>LSH provides ~100-1000x speedup for large perceptual matching</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="trashDirPreset">üóëÔ∏è Trash Directory (preset)</label>
                        <input type="text" id="trashDirPreset" placeholder="Leave empty to set when deleting">
                        <small>Where duplicates will be moved to (optional)</small>
                    </div>
                </div>
            </div>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" id="scanBtn" onclick="startScan()">
                    üöÄ Start Scan
                </button>
            </div>
            
            <!-- Progress Section -->
            <div class="progress-section" id="progressSection">
                <!-- Stage Indicators -->
                <div class="stage-indicators">
                    <div class="stage-indicator" id="stageScanning">
                        <div class="stage-dot">üìÅ</div>
                        <div class="stage-label">Scanning</div>
                    </div>
                    <div class="stage-indicator" id="stageAnalyzing">
                        <div class="stage-dot">üî¨</div>
                        <div class="stage-label">Analyzing</div>
                    </div>
                    <div class="stage-indicator" id="stageExact">
                        <div class="stage-dot">üîó</div>
                        <div class="stage-label">Exact Match</div>
                    </div>
                    <div class="stage-indicator" id="stagePerceptual">
                        <div class="stage-dot">üëÅÔ∏è</div>
                        <div class="stage-label">Perceptual</div>
                    </div>
                    <div class="stage-indicator" id="stageComplete">
                        <div class="stage-dot">‚úÖ</div>
                        <div class="stage-label">Complete</div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="progress-header">
                        <span class="progress-title" id="progressTitle">Initializing...</span>
                        <span class="progress-percentage" id="progressPercentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill animated" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Preparing scan...</div>
                </div>
                
                <!-- Live Stats -->
                <div class="live-stats" id="liveStats">
                    <div class="live-stat">
                        <div class="live-stat-value" id="liveTotalFiles">0</div>
                        <div class="live-stat-label">Total Files</div>
                    </div>
                    <div class="live-stat">
                        <div class="live-stat-value" id="liveAnalyzed">0</div>
                        <div class="live-stat-label">Analyzed</div>
                    </div>
                    <div class="live-stat">
                        <div class="live-stat-value" id="liveRate">0/s</div>
                        <div class="live-stat-label">Speed</div>
                    </div>
                    <div class="live-stat">
                        <div class="live-stat-value" id="liveEta">--</div>
                        <div class="live-stat-label">ETA</div>
                    </div>
                    <div class="live-stat">
                        <div class="live-stat-value cache" id="liveCacheHits">0</div>
                        <div class="live-stat-label">Cache Hits</div>
                    </div>
                    <div class="live-stat">
                        <div class="live-stat-value" id="liveElapsed">0s</div>
                        <div class="live-stat-label">Elapsed</div>
                    </div>
                </div>
                
                <!-- Scan Controls -->
                <div class="scan-controls">
                    <button class="btn btn-warning btn-sm" id="pauseBtn" onclick="pauseScan()" style="display: none;">
                        ‚è∏Ô∏è Pause
                    </button>
                    <button class="btn btn-success btn-sm" id="resumeBtn" onclick="resumeScan()" style="display: none;">
                        ‚ñ∂Ô∏è Resume
                    </button>
                    <button class="btn btn-danger btn-sm" id="cancelBtn" onclick="cancelScan()">
                        ‚úñÔ∏è Cancel Scan
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Stats Bar -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <div class="stat-value" id="statGroups">0</div>
                <div class="stat-label">Duplicate Groups</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statDupes">0</div>
                <div class="stat-label">Total Duplicates</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statSavings">0 MB</div>
                <div class="stat-label">Potential Savings</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statSelected">0</div>
                <div class="stat-label">Selected for Removal</div>
            </div>
            <div class="stat-item" id="statErrorsContainer" style="display: none;">
                <div class="stat-value error" id="statErrors">0</div>
                <div class="stat-label">Failed to Analyze</div>
            </div>
            <div class="stat-item" style="margin-left: auto;">
                <button class="btn btn-secondary btn-sm" onclick="newScan()">üîÑ New Scan</button>
            </div>
        </div>
        
        <!-- Cache Banner -->
        <div class="cache-banner" id="cacheBanner">
            <span id="cacheInfo">‚ö° Cache: Loading...</span>
            <button class="btn btn-sm" onclick="showCacheModal()" style="margin-left: 10px; padding: 4px 12px; background: #333;">Manage Cache</button>
        </div>
        
        <!-- Filter Bar -->
        <div class="filter-bar" id="filterBar">
            <select id="filterType" onchange="applyFilters()">
                <option value="all">All Groups</option>
                <option value="exact">Exact Matches Only</option>
                <option value="perceptual">Perceptual Matches Only</option>
            </select>
            <select id="sortBy" onchange="applyFilters()">
                <option value="savings">Sort by Savings (High to Low)</option>
                <option value="count">Sort by Image Count</option>
                <option value="id">Sort by Group ID</option>
            </select>
            <input type="text" id="searchFilter" placeholder="Search by filename..." oninput="applyFilters()">
            
            <div class="strategy-selector">
                <label for="strategySelect">Auto-select:</label>
                <select id="strategySelect" onchange="applyStrategy()">
                    <option value="quality">Highest Quality</option>
                    <option value="largest">Largest File</option>
                    <option value="smallest">Smallest File</option>
                    <option value="newest">Newest File</option>
                    <option value="oldest">Oldest File</option>
                </select>
            </div>
            
            <div class="pagination">
                <button onclick="prevPage()" id="prevBtn">‚Üê Prev</button>
                <span id="pageInfo">Page 1 of 1</span>
                <button onclick="nextPage()" id="nextBtn">Next ‚Üí</button>
            </div>
        </div>
        
        <!-- Groups Container -->
        <div class="groups-container" id="groupsContainer"></div>
        
        <!-- Error Images Section -->
        <div class="error-section" id="errorSection">
            <div class="error-section-header" onclick="toggleErrorSection()">
                <div class="error-section-title">
                    ‚ö†Ô∏è <span id="errorSectionCount">0</span> Images Could Not Be Analyzed
                </div>
                <div class="error-section-toggle">‚ñº</div>
            </div>
            <div class="error-section-content">
                <p style="color: #888; margin-bottom: 15px;">
                    These images encountered errors during analysis (corrupt files, unsupported formats, permission issues, etc.)
                </p>
                <div class="error-images-grid" id="errorImagesGrid"></div>
            </div>
        </div>
        
        <!-- Action Bar -->
        <div class="action-bar" id="actionBar">
            <div class="action-summary">
                <strong id="actionSummary">0 files selected for removal</strong>
                <span id="actionSavings" style="color: #888; margin-left: 10px;"></span>
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="resetSelections()">Reset All</button>
                <button class="btn btn-secondary" onclick="exportSelections()">üìã Export List</button>
                <button class="btn btn-danger" onclick="showDeleteModal()">üóëÔ∏è Move to Trash</button>
            </div>
        </div>
    </div>
    
    <!-- Undo Toast -->
    <div class="undo-toast" id="undoToast">
        <span id="undoMessage">Selection changed</span>
        <button class="btn btn-sm btn-primary" onclick="undoAction()">Undo</button>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <h2>‚ö†Ô∏è Confirm Deletion</h2>
            <p id="deleteModalText">Are you sure you want to move X files to the trash folder?</p>
            <div class="form-group">
                <label for="trashDir">Trash Directory</label>
                <input type="text" id="trashDir" placeholder="e.g., C:\Duplicates_Trash">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="executeDelete()">Move to Trash</button>
            </div>
        </div>
    </div>
    
    <!-- Cache Management Modal -->
    <div class="modal-overlay" id="cacheModal">
        <div class="modal">
            <h2>üì¶ Cache Management</h2>
            <p style="color: #888; margin-bottom: 20px;">
                The cache stores analysis results to speed up re-scans of the same directories.
            </p>
            <div style="background: #0f0f23; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #888;">Cached Images:</span>
                    <span id="cacheModalEntries" style="color: #fff; font-weight: 600;">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #888;">Database Size:</span>
                    <span id="cacheModalSize" style="color: #fff; font-weight: 600;">0 MB</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #888;">Location:</span>
                    <span id="cacheModalPath" style="color: #666; font-size: 0.8rem; word-break: break-all;">~/.duplicate_finder_cache.db</span>
                </div>
            </div>
            <div class="modal-buttons" style="flex-wrap: wrap; gap: 10px;">
                <button class="btn btn-secondary" onclick="cleanupCache()">üóëÔ∏è Cleanup Old Entries</button>
                <button class="btn btn-danger" onclick="clearCache()">üí• Clear All Cache</button>
                <button class="btn btn-secondary" onclick="hideCacheModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
        <button class="lightbox-nav prev" onclick="lightboxPrev(event)">‚Äπ</button>
        <img id="lightboxImg" src="" alt="">
        <button class="lightbox-nav next" onclick="lightboxNext(event)">‚Ä∫</button>
    </div>
    
    <script>
        // =============================================================
        // State
        // =============================================================
        let scanInterval = null;
        let groups = [];
        let filteredGroups = [];
        let selections = {};
        let undoStack = [];
        let directoryHistory = [];
        let errorImages = [];
        let currentPage = 1;
        const PAGE_SIZE = 10;
        let lightboxImages = [];
        let lightboxIndex = 0;
        let lastPollTime = Date.now();
        let connectionLost = false;
        let scanDirectory = '';
        let isScanning = false;
        let isPaused = false;
        
        // =============================================================
        // Initialization
        // =============================================================
        document.addEventListener('DOMContentLoaded', () => {
            checkForRecovery();
            loadDirectoryHistory();
            startConnectionMonitor();
            updateThresholdDisplay();
            updateWorkersDisplay();
        });
        
        function checkForRecovery() {
            loadCacheStats();
            
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'complete' && data.has_results) {
                        let info = `Found ${data.group_count} duplicate groups from: ${data.directory}`;
                        if (data.error_count > 0) {
                            info += ` (${data.error_count} files had errors)`;
                        }
                        document.getElementById('recoveryBanner').classList.add('active');
                        document.getElementById('recoveryInfo').textContent = info;
                        
                        if (data.auto_disabled_perceptual) {
                            showPerceptualWarning(data.directory);
                        }
                    } else if (['scanning', 'analyzing', 'comparing'].includes(data.status)) {
                        // Resume tracking an in-progress scan
                        isScanning = true;
                        showProgressSection();
                        startProgressPolling();
                    }
                });
        }
        
        function showPerceptualWarning(directory) {
            document.getElementById('warningBanner').classList.add('active');
        }
        
        function hidePerceptualWarning() {
            document.getElementById('warningBanner').classList.remove('active');
        }
        
        function restoreSession() {
            document.getElementById('recoveryBanner').classList.remove('active');
            loadResults();
        }
        
        function dismissRecovery() {
            document.getElementById('recoveryBanner').classList.remove('active');
            hidePerceptualWarning();
            fetch('/api/clear', { method: 'POST' });
        }
        
        function loadDirectoryHistory() {
            fetch('/api/history')
                .then(r => r.json())
                .then(data => {
                    directoryHistory = data.directories || [];
                });
        }
        
        // =============================================================
        // UI Helpers
        // =============================================================
        function updateThresholdDisplay() {
            const val = document.getElementById('threshold').value;
            document.getElementById('thresholdValue').textContent = val;
        }
        
        function updateWorkersDisplay() {
            const val = document.getElementById('workers').value;
            document.getElementById('workersValue').textContent = val;
        }
        
        function toggleAdvancedOptions() {
            const toggle = document.querySelector('.advanced-toggle');
            const content = document.getElementById('advancedContent');
            toggle.classList.toggle('expanded');
            content.classList.toggle('active');
        }
        
        function toggleDetectionMode(mode) {
            if (mode === 'exact' && document.getElementById('exactOnly').checked) {
                document.getElementById('perceptualOnly').checked = false;
            } else if (mode === 'perceptual' && document.getElementById('perceptualOnly').checked) {
                document.getElementById('exactOnly').checked = false;
            }
        }
        
        // =============================================================
        // Connection Monitoring
        // =============================================================
        function startConnectionMonitor() {
            setInterval(() => {
                fetch('/api/ping')
                    .then(r => {
                        if (r.ok) {
                            if (connectionLost) {
                                connectionLost = false;
                                updateConnectionStatus(true);
                            }
                            lastPollTime = Date.now();
                        }
                    })
                    .catch(() => {
                        connectionLost = true;
                        updateConnectionStatus(false);
                    });
            }, 5000);
        }
        
        function updateConnectionStatus(connected) {
            const el = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            if (connected) {
                el.className = 'connection-status connected';
                text.textContent = 'Connected';
            } else {
                el.className = 'connection-status disconnected';
                text.textContent = 'Disconnected - Retrying...';
            }
        }
        
        // =============================================================
        // Directory History/Autocomplete
        // =============================================================
        function showHistory() {
            renderHistory(directoryHistory);
        }
        
        function filterHistory() {
            const input = document.getElementById('directory').value.toLowerCase();
            const filtered = directoryHistory.filter(d => d.toLowerCase().includes(input));
            renderHistory(filtered);
        }
        
        function renderHistory(dirs) {
            const list = document.getElementById('historyList');
            if (dirs.length === 0) {
                list.classList.remove('active');
                return;
            }
            list.innerHTML = dirs.map(d => 
                `<div class="autocomplete-item" onclick="selectDirectory('${escapeJs(d)}')">${escapeHtml(d)}</div>`
            ).join('');
            list.classList.add('active');
        }
        
        function selectDirectory(dir) {
            document.getElementById('directory').value = dir;
            document.getElementById('historyList').classList.remove('active');
        }
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.form-group')) {
                document.getElementById('historyList').classList.remove('active');
            }
        });
        
        // =============================================================
        // Scanning
        // =============================================================
        function startScan() {
            const directory = document.getElementById('directory').value.trim();
            if (!directory) {
                alert('Please enter a directory path');
                return;
            }
            
            const threshold = parseInt(document.getElementById('threshold').value) || 10;
            const exactOnly = document.getElementById('exactOnly').checked;
            const perceptualOnly = document.getElementById('perceptualOnly').checked;
            const recursive = document.getElementById('recursive').checked;
            const useCache = document.getElementById('useCache').checked;
            const workers = parseInt(document.getElementById('workers').value) || 4;
            const autoSelectStrategy = document.getElementById('autoSelectStrategy').value;
            
            // Get LSH mode
            let useLsh = null;
            const lshMode = document.querySelector('input[name="lshMode"]:checked').value;
            if (lshMode === 'on') useLsh = true;
            else if (lshMode === 'off') useLsh = false;
            
            scanDirectory = directory;
            hidePerceptualWarning();
            
            // Send scan request
            fetch('/api/scan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    directory,
                    threshold,
                    exactOnly,
                    perceptualOnly,
                    recursive,
                    useCache,
                    useLsh,
                    workers,
                    autoSelectStrategy,
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                isScanning = true;
                isPaused = false;
                showProgressSection();
                startProgressPolling();
            })
            .catch(err => {
                alert('Failed to start scan: ' + err);
            });
        }
        
        function showProgressSection() {
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('progressSection').classList.add('active');
            document.getElementById('groupsContainer').classList.remove('active');
            document.getElementById('statsBar').classList.remove('active');
            document.getElementById('actionBar').classList.remove('active');
            document.getElementById('filterBar').classList.remove('active');
            document.getElementById('errorSection').classList.remove('active');
            
            // Reset stage indicators
            document.querySelectorAll('.stage-indicator').forEach(el => {
                el.classList.remove('active', 'completed', 'error');
            });
            
            // Show cancel button
            document.getElementById('cancelBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('resumeBtn').style.display = 'none';
        }
        
        function hideProgressSection() {
            document.getElementById('scanBtn').disabled = false;
            document.getElementById('progressSection').classList.remove('active');
            document.getElementById('progressFill').classList.remove('animated');
        }
        
        function startProgressPolling() {
            if (scanInterval) clearInterval(scanInterval);
            scanInterval = setInterval(checkProgress, 500);
        }
        
        function checkProgress() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    updateProgressUI(data);
                    
                    if (data.status === 'complete' || data.status === 'error' || data.status === 'cancelled') {
                        clearInterval(scanInterval);
                        scanInterval = null;
                        isScanning = false;
                        
                        if (data.status === 'complete') {
                            if (data.auto_disabled_perceptual) {
                                showPerceptualWarning(scanDirectory);
                            }
                            loadResults();
                        } else if (data.status === 'cancelled') {
                            hideProgressSection();
                            alert('Scan cancelled');
                        } else {
                            hideProgressSection();
                            alert('Scan error: ' + data.message);
                        }
                    }
                    
                    // Handle pause state
                    isPaused = data.paused;
                    if (isPaused) {
                        document.getElementById('pauseBtn').style.display = 'none';
                        document.getElementById('resumeBtn').style.display = 'inline-block';
                    } else {
                        document.getElementById('pauseBtn').style.display = 'inline-block';
                        document.getElementById('resumeBtn').style.display = 'none';
                    }
                })
                .catch(() => {});
        }
        
        function updateProgressUI(data) {
            // Update progress bar
            document.getElementById('progressFill').style.width = data.progress + '%';
            document.getElementById('progressPercentage').textContent = data.progress + '%';
            document.getElementById('progressText').textContent = data.message;
            
            // Update stage title
            const stageNames = {
                'idle': 'Starting...',
                'scanning': 'Scanning Files',
                'analyzing': 'Analyzing Images',
                'exact_matching': 'Finding Exact Duplicates',
                'perceptual_matching': 'Finding Similar Images',
                'complete': 'Complete'
            };
            document.getElementById('progressTitle').textContent = stageNames[data.stage] || data.stage;
            
            // Update stage indicators
            updateStageIndicators(data.stage);
            
            // Update live stats
            const details = data.progress_details || {};
            document.getElementById('liveTotalFiles').textContent = formatNumber(data.total_files || 0);
            document.getElementById('liveAnalyzed').textContent = formatNumber(data.analyzed || 0);
            document.getElementById('liveRate').textContent = (details.rate || 0).toFixed(1) + '/s';
            document.getElementById('liveEta').textContent = formatEta(details.eta_seconds);
            document.getElementById('liveCacheHits').textContent = formatNumber(details.cache_hits || 0);
            document.getElementById('liveElapsed').textContent = formatElapsed(details.elapsed_seconds || 0);
        }
        
        function updateStageIndicators(stage) {
            const stages = ['scanning', 'analyzing', 'exact_matching', 'perceptual_matching', 'complete'];
            const stageMap = {
                'scanning': 'stageScanning',
                'analyzing': 'stageAnalyzing',
                'exact_matching': 'stageExact',
                'perceptual_matching': 'stagePerceptual',
                'complete': 'stageComplete'
            };
            
            const currentIndex = stages.indexOf(stage);
            
            for (let i = 0; i < stages.length; i++) {
                const el = document.getElementById(stageMap[stages[i]]);
                if (!el) continue;
                
                el.classList.remove('active', 'completed');
                
                if (i < currentIndex) {
                    el.classList.add('completed');
                } else if (i === currentIndex) {
                    el.classList.add('active');
                }
            }
        }
        
        function cancelScan() {
            if (confirm('Are you sure you want to cancel the scan?')) {
                fetch('/api/cancel', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'cancel_requested') {
                            document.getElementById('progressText').textContent = 'Cancelling...';
                        }
                    });
            }
        }
        
        function pauseScan() {
            fetch('/api/pause', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'paused') {
                        document.getElementById('pauseBtn').style.display = 'none';
                        document.getElementById('resumeBtn').style.display = 'inline-block';
                        document.getElementById('progressFill').classList.remove('animated');
                    }
                });
        }
        
        function resumeScan() {
            fetch('/api/resume', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'resumed') {
                        document.getElementById('pauseBtn').style.display = 'inline-block';
                        document.getElementById('resumeBtn').style.display = 'none';
                        document.getElementById('progressFill').classList.add('animated');
                    }
                });
        }
        
        function loadResults() {
            fetch('/api/groups')
                .then(r => r.json())
                .then(data => {
                    groups = data.groups;
                    selections = data.selections || {};
                    errorImages = data.error_images || [];
                    
                    if (Object.keys(selections).length === 0) {
                        groups.forEach(g => {
                            g.images.forEach((img, idx) => {
                                selections[img.path] = idx === 0 ? 'keep' : 'delete';
                            });
                        });
                    }
                    
                    if (data.directory && !directoryHistory.includes(data.directory)) {
                        directoryHistory.unshift(data.directory);
                        directoryHistory = directoryHistory.slice(0, 10);
                    }
                    
                    // Sync strategy dropdown
                    if (data.settings && data.settings.auto_select_strategy) {
                        document.getElementById('strategySelect').value = data.settings.auto_select_strategy;
                    }
                    
                    currentPage = 1;
                    applyFilters();
                    updateStats();
                    renderErrorImages();
                    
                    hideProgressSection();
                    document.getElementById('groupsContainer').classList.add('active');
                    document.getElementById('statsBar').classList.add('active');
                    document.getElementById('filterBar').classList.add('active');
                    
                    if (groups.length > 0) {
                        document.getElementById('actionBar').classList.add('active');
                    }
                    
                    loadCacheStats();
                });
        }
        
        function newScan() {
            if (confirm('Start a new scan? Current results will be cleared.')) {
                fetch('/api/clear', { method: 'POST' }).then(() => {
                    groups = [];
                    selections = {};
                    errorImages = [];
                    hidePerceptualWarning();
                    document.getElementById('groupsContainer').classList.remove('active');
                    document.getElementById('statsBar').classList.remove('active');
                    document.getElementById('actionBar').classList.remove('active');
                    document.getElementById('filterBar').classList.remove('active');
                    document.getElementById('cacheBanner').classList.remove('active');
                    document.getElementById('errorSection').classList.remove('active');
                });
            }
        }
        
        // =============================================================
        // Error Images Display
        // =============================================================
        function renderErrorImages() {
            const section = document.getElementById('errorSection');
            const grid = document.getElementById('errorImagesGrid');
            const countEl = document.getElementById('errorSectionCount');
            
            if (errorImages.length === 0) {
                section.classList.remove('active');
                return;
            }
            
            section.classList.add('active');
            countEl.textContent = errorImages.length;
            
            grid.innerHTML = errorImages.map(img => `
                <div class="error-image-item">
                    <div class="error-image-path">${escapeHtml(img.path)}</div>
                    <div class="error-image-error">${escapeHtml(img.error || 'Unknown error')}</div>
                </div>
            `).join('');
        }
        
        function toggleErrorSection() {
            const section = document.getElementById('errorSection');
            section.classList.toggle('expanded');
        }
        
        // =============================================================
        // Filtering & Pagination
        // =============================================================
        function applyFilters() {
            const typeFilter = document.getElementById('filterType').value;
            const sortBy = document.getElementById('sortBy').value;
            const search = document.getElementById('searchFilter').value.toLowerCase();
            
            filteredGroups = groups.filter(g => {
                if (typeFilter !== 'all' && g.match_type !== typeFilter) return false;
                if (search) {
                    const hasMatch = g.images.some(img => 
                        img.filename.toLowerCase().includes(search) ||
                        img.directory.toLowerCase().includes(search)
                    );
                    if (!hasMatch) return false;
                }
                return true;
            });
            
            filteredGroups.sort((a, b) => {
                if (sortBy === 'savings') return b.potential_savings - a.potential_savings;
                if (sortBy === 'count') return b.image_count - a.image_count;
                return a.id - b.id;
            });
            
            currentPage = 1;
            renderGroups();
            updatePagination();
        }
        
        function applyStrategy() {
            const strategy = document.getElementById('strategySelect').value;
            
            fetch('/api/apply_strategy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ strategy })
            })
            .then(r => r.json())
            .then(data => {
                if (data.selections) {
                    selections = data.selections;
                    renderGroups();
                    updateStats();
                    showUndoToast('Selection strategy applied: ' + strategy);
                }
            });
        }
        
        function updatePagination() {
            const totalPages = Math.ceil(filteredGroups.length / PAGE_SIZE) || 1;
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }
        
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderGroups();
                updatePagination();
                window.scrollTo(0, 0);
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(filteredGroups.length / PAGE_SIZE);
            if (currentPage < totalPages) {
                currentPage++;
                renderGroups();
                updatePagination();
                window.scrollTo(0, 0);
            }
        }
        
        // =============================================================
        // Rendering
        // =============================================================
        function renderGroups() {
            const container = document.getElementById('groupsContainer');
            
            if (filteredGroups.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <h2>‚ú® No Duplicates Found!</h2>
                        <p>Your image collection is clean, or no matches for current filters.</p>
                    </div>
                `;
                return;
            }
            
            const start = (currentPage - 1) * PAGE_SIZE;
            const pageGroups = filteredGroups.slice(start, start + PAGE_SIZE);
            
            container.innerHTML = pageGroups.map((group, groupIdx) => `
                <div class="group-card" data-group-id="${group.id}">
                    <div class="group-header">
                        <div class="group-title">
                            Group #${group.id} 
                            <span style="color: #888; font-weight: normal;">(${group.image_count} images)</span>
                        </div>
                        <div>
                            <span class="group-badge ${group.match_type}">${group.match_type}</span>
                            <span style="margin-left: 10px; color: #888;">Save ${group.potential_savings_formatted}</span>
                        </div>
                    </div>
                    <div class="group-images">
                        ${group.images.map((img, idx) => `
                            <div class="image-card ${selections[img.path] === 'keep' ? 'selected' : 'to-delete'}" 
                                 data-path="${escapeHtml(img.path)}"
                                 onclick="toggleSelection('${escapeJs(img.path)}', ${group.id})">
                                <div class="image-wrapper">
                                    <img class="image-preview" 
                                         src="/api/image?path=${encodeURIComponent(img.path)}" 
                                         alt="${escapeHtml(img.filename)}"
                                         loading="lazy"
                                         onerror="this.alt='Failed to load'"
                                         ondblclick="event.stopPropagation(); openLightbox(${group.id}, ${idx})">
                                    ${selections[img.path] === 'keep' 
                                        ? '<div class="keep-badge">‚úî KEEP</div>' 
                                        : '<div class="delete-badge">‚úñ DELETE</div>'}
                                </div>
                                <div class="image-info">
                                    <div class="image-filename">${escapeHtml(img.filename)}</div>
                                    <div class="image-path">${escapeHtml(img.directory)}</div>
                                    <div class="image-meta">
                                        <div class="meta-item">
                                            <span class="meta-label">Size</span>
                                            <span class="meta-value">${img.file_size_formatted}</span>
                                        </div>
                                        <div class="meta-item">
                                            <span class="meta-label">Resolution</span>
                                            <span class="meta-value">${img.resolution}</span>
                                        </div>
                                        <div class="meta-item">
                                            <span class="meta-label">Megapixels</span>
                                            <span class="meta-value">${img.megapixels} MP</span>
                                        </div>
                                        <div class="meta-item">
                                            <span class="meta-label">Format</span>
                                            <span class="meta-value">${img.format || 'Unknown'}</span>
                                        </div>
                                    </div>
                                    <div class="quality-score">
                                        <div class="meta-item">
                                            <span class="meta-label">Quality Score</span>
                                            <span class="meta-value">${img.quality_score}</span>
                                        </div>
                                        <div class="quality-bar">
                                            <div class="quality-fill" style="width: ${Math.min(100, img.quality_score)}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        // =============================================================
        // Selection Management
        // =============================================================
        function toggleSelection(path, groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            const prevSelections = {...selections};
            undoStack.push({ type: 'selection', data: prevSelections });
            if (undoStack.length > 50) undoStack.shift();
            
            if (selections[path] === 'delete') {
                group.images.forEach(img => {
                    selections[img.path] = img.path === path ? 'keep' : 'delete';
                });
            }
            
            saveSelections();
            renderGroups();
            updateStats();
            showUndoToast('Selection updated');
        }
        
        function saveSelections() {
            fetch('/api/selections', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ selections })
            });
        }
        
        function resetSelections() {
            const prevSelections = {...selections};
            undoStack.push({ type: 'selection', data: prevSelections });
            
            groups.forEach(g => {
                g.images.forEach((img, idx) => {
                    selections[img.path] = idx === 0 ? 'keep' : 'delete';
                });
            });
            
            saveSelections();
            renderGroups();
            updateStats();
        }
        
        function updateStats() {
            const totalGroups = groups.length;
            const totalDupes = groups.reduce((sum, g) => sum + g.images.length - 1, 0);
            
            let selectedCount = 0;
            let selectedSize = 0;
            
            Object.entries(selections).forEach(([path, status]) => {
                if (status === 'delete') {
                    selectedCount++;
                    for (const g of groups) {
                        const img = g.images.find(i => i.path === path);
                        if (img) {
                            selectedSize += img.file_size;
                            break;
                        }
                    }
                }
            });
            
            document.getElementById('statGroups').textContent = totalGroups;
            document.getElementById('statDupes').textContent = totalDupes;
            document.getElementById('statSavings').textContent = formatSize(selectedSize);
            document.getElementById('statSelected').textContent = selectedCount;
            
            if (errorImages.length > 0) {
                document.getElementById('statErrorsContainer').style.display = 'block';
                document.getElementById('statErrors').textContent = errorImages.length;
            } else {
                document.getElementById('statErrorsContainer').style.display = 'none';
            }
            
            document.getElementById('actionSummary').textContent = `${selectedCount} files selected for removal`;
            document.getElementById('actionSavings').textContent = `(${formatSize(selectedSize)})`;
        }
        
        // =============================================================
        // Undo
        // =============================================================
        function showUndoToast(message) {
            const toast = document.getElementById('undoToast');
            document.getElementById('undoMessage').textContent = message;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 5000);
        }
        
        function undoAction() {
            if (undoStack.length === 0) return;
            
            const action = undoStack.pop();
            if (action.type === 'selection') {
                selections = action.data;
                saveSelections();
                renderGroups();
                updateStats();
            }
            
            document.getElementById('undoToast').classList.remove('active');
        }
        
        // =============================================================
        // Export
        // =============================================================
        function exportSelections() {
            const lines = ['# Duplicate Image Report', ''];
            
            groups.forEach(g => {
                lines.push(`## Group ${g.id} (${g.match_type})`);
                g.images.forEach(img => {
                    const status = selections[img.path] === 'keep' ? 'KEEP' : 'DELETE';
                    lines.push(`[${status}] ${img.path}`);
                });
                lines.push('');
            });
            
            if (errorImages.length > 0) {
                lines.push('## Failed to Analyze');
                errorImages.forEach(img => {
                    lines.push(`[ERROR] ${img.path}`);
                    lines.push(`        Reason: ${img.error || 'Unknown error'}`);
                });
                lines.push('');
            }
            
            const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'duplicate_report.txt';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // =============================================================
        // Delete Modal
        // =============================================================
        function showDeleteModal() {
            const count = Object.values(selections).filter(s => s === 'delete').length;
            if (count === 0) {
                alert('No files selected for removal');
                return;
            }
            document.getElementById('deleteModalText').textContent = 
                `Are you sure you want to move ${count} files to the trash folder?`;
            
            // Use preset trash dir or suggest one
            const preset = document.getElementById('trashDirPreset').value.trim();
            const scanDir = document.getElementById('directory').value.trim();
            
            if (preset) {
                document.getElementById('trashDir').value = preset;
            } else if (scanDir && !document.getElementById('trashDir').value) {
                document.getElementById('trashDir').value = scanDir + '_duplicates_trash';
            }
            
            document.getElementById('deleteModal').classList.add('active');
        }
        
        function hideDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }
        
        function executeDelete() {
            const trashDir = document.getElementById('trashDir').value.trim();
            if (!trashDir) {
                alert('Please enter a trash directory');
                return;
            }
            
            const filesToDelete = Object.entries(selections)
                .filter(([path, status]) => status === 'delete')
                .map(([path]) => path);
            
            fetch('/api/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({files: filesToDelete, trashDir})
            })
            .then(r => r.json())
            .then(data => {
                hideDeleteModal();
                alert(`Moved ${data.moved} files to trash.\n${data.errors} errors.`);
                
                groups.forEach(g => {
                    g.images = g.images.filter(img => !filesToDelete.includes(img.path));
                });
                groups = groups.filter(g => g.images.length > 1);
                
                filesToDelete.forEach(path => delete selections[path]);
                
                applyFilters();
                updateStats();
                
                if (groups.length === 0) {
                    document.getElementById('actionBar').classList.remove('active');
                }
            });
        }
        
        // =============================================================
        // Lightbox
        // =============================================================
        function openLightbox(groupId, imgIdx) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            lightboxImages = group.images.map(img => img.path);
            lightboxIndex = imgIdx;
            
            updateLightboxImage();
            document.getElementById('lightbox').classList.add('active');
        }
        
        function updateLightboxImage() {
            const path = lightboxImages[lightboxIndex];
            document.getElementById('lightboxImg').src = '/api/image?path=' + encodeURIComponent(path);
        }
        
        function lightboxPrev(e) {
            e.stopPropagation();
            lightboxIndex = (lightboxIndex - 1 + lightboxImages.length) % lightboxImages.length;
            updateLightboxImage();
        }
        
        function lightboxNext(e) {
            e.stopPropagation();
            lightboxIndex = (lightboxIndex + 1) % lightboxImages.length;
            updateLightboxImage();
        }
        
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
        }
        
        // =============================================================
        // Keyboard Navigation
        // =============================================================
        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT') return;
            
            if (e.key === 'Escape') {
                closeLightbox();
                hideDeleteModal();
                hideCacheModal();
                return;
            }
            
            if (document.getElementById('lightbox').classList.contains('active')) {
                if (e.key === 'ArrowLeft') lightboxPrev(e);
                if (e.key === 'ArrowRight') lightboxNext(e);
                return;
            }
            
            if (e.key === 'z' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                undoAction();
                return;
            }
            
            if (e.key === 'z') {
                undoAction();
                return;
            }
        });
        
        // =============================================================
        // Cache Management
        // =============================================================
        function loadCacheStats() {
            fetch('/api/cache/stats')
                .then(r => r.json())
                .then(data => {
                    const entries = data.total_entries || 0;
                    const sizeMb = data.db_size_mb || 0;
                    
                    document.getElementById('cacheInfo').textContent = 
                        `‚ö° Cache: ${entries.toLocaleString()} images cached (${sizeMb} MB)`;
                    document.getElementById('cacheModalEntries').textContent = entries.toLocaleString();
                    document.getElementById('cacheModalSize').textContent = `${sizeMb} MB`;
                    document.getElementById('cacheModalPath').textContent = data.db_path || 'Unknown';
                    
                    if (entries > 0) {
                        document.getElementById('cacheBanner').classList.add('active');
                    }
                })
                .catch(() => {
                    document.getElementById('cacheInfo').textContent = '‚ö° Cache: Unable to load stats';
                });
        }
        
        function showCacheModal() {
            loadCacheStats();
            document.getElementById('cacheModal').classList.add('active');
        }
        
        function hideCacheModal() {
            document.getElementById('cacheModal').classList.remove('active');
        }
        
        function clearCache() {
            if (!confirm('Clear all cached analysis data? Next scan will re-analyze all images.')) {
                return;
            }
            
            fetch('/api/cache/clear', { method: 'POST' })
                .then(r => r.json())
                .then(() => {
                    alert('Cache cleared successfully.');
                    loadCacheStats();
                    document.getElementById('cacheBanner').classList.remove('active');
                })
                .catch(() => alert('Failed to clear cache.'));
        }
        
        function cleanupCache() {
            fetch('/api/cache/cleanup', { 
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ max_age_days: 30 })
            })
                .then(r => r.json())
                .then(data => {
                    alert(`Cleanup complete:\n- Removed ${data.missing_removed} entries for deleted files\n- Removed ${data.stale_removed} stale entries`);
                    loadCacheStats();
                })
                .catch(() => alert('Failed to cleanup cache.'));
        }
        
        // =============================================================
        // Utilities
        // =============================================================
        function formatSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return bytes.toFixed(1) + ' ' + units[i];
        }
        
        function formatNumber(n) {
            return n.toLocaleString();
        }
        
        function formatEta(seconds) {
            if (!seconds || seconds <= 0) return '--';
            if (seconds < 60) return Math.round(seconds) + 's';
            if (seconds < 3600) {
                const m = Math.floor(seconds / 60);
                const s = Math.round(seconds % 60);
                return `${m}m ${s}s`;
            }
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h}h ${m}m`;
        }
        
        function formatElapsed(seconds) {
            if (!seconds || seconds <= 0) return '0s';
            if (seconds < 60) return Math.round(seconds) + 's';
            if (seconds < 3600) {
                const m = Math.floor(seconds / 60);
                const s = Math.round(seconds % 60);
                return `${m}m ${s}s`;
            }
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h}h ${m}m`;
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        function escapeJs(str) {
            if (!str) return '';
            return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        }
    </script>
</body>
</html>